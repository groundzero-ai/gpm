{
  "$schema": "./schemas/platforms-v1.json",

  // Global flows that apply to all platforms
  "global": {
    "export": [
      {
        "from": "AGENTS.md",
        "to": "AGENTS.md",
        "when": { "exists": "AGENTS.md" },
        "merge": "composite"
      }
    ],
    "import": [
      {
        "from": "AGENTS.md",
        "to": "AGENTS.md",
        "merge": "composite"
      }
    ]
  },

  // Platform definitions for all supported AI coding platforms
  // Each platform defines export flows (package → workspace) and import flows (workspace → package)

  "antigravity": {
    "name": "Google Antigravity",
    "rootDir": ".agent",
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".agent/rules/**/*.md"
      },
      {
        "from": "commands/**/*.md",
        "to": ".agent/workflows/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".agent/skills/**/*"
      }
    ],
    "import": [
      {
        "from": ".agent/rules/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": ".agent/workflows/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".agent/skills/**/*",
        "to": "skills/**/*"
      }
    ]
  },

  "augment": {
    "name": "Augment Code",
    "rootDir": ".augment",
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".augment/rules/**/*.md"
      },
      {
        "from": "commands/**/*.md",
        "to": ".augment/commands/**/*.md"
      }
    ],
    "import": [
      {
        "from": ".augment/rules/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": ".augment/commands/**/*.md",
        "to": "commands/**/*.md"
      }
    ]
  },

  "claude": {
    "name": "Claude Code",
    "rootDir": ".claude",
    "rootFile": "CLAUDE.md",
    "aliases": ["claudecode"],
    "export": [
      {
        "from": "AGENTS.md",
        "to": "CLAUDE.md",
        "merge": "composite"
      },
      {
        "from": "rules/**/*.md",
        "to": ".claude/rules/**/*.md"
      },
      {
        "from": "commands/**/*.md",
        "to": ".claude/commands/**/*.md"
      },
      {
        "from": "agents/**/*.md",
        "to": ".claude/agents/**/*.md",
        "map": [
          // Set name from context
          { "$set": { "name": "$$filename" } },
          // Transform model conditionally:
          // - If it starts with "anthropic/", apply regex transformations
          // - Otherwise, set to "default"
          {
            "$pipeline": {
              "field": "model",
              "operations": [
                // First, check if it's an Anthropic model. If not, replace with "default"
                { "$replace": { "pattern": "^(?!anthropic/).*$", "with": "default" } },
                // Then apply Anthropic transformations (these only affect anthropic/* models)
                { "$replace": { "pattern": "^anthropic/", "with": "" } },
                { "$replace": { "pattern": "(-[0-9]+)\\.([0-9]+)", "with": "$1-$2", "flags": "g" } }
              ]
            }
          },
          // Transform tools: object → string
          {
            "$pipeline": {
              "field": "tools",
              "operations": [
                { "$filter": { "match": { "value": true } } },
                { "$objectToArray": { "extract": "keys" } },
                { "$reduce": { "type": "join", "separator": ", " } }
              ]
            }
          },
          { "$unset": "permission" }
        ]
      },
      {
        "from": "skills/**/*",
        "to": ".claude/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": "CLAUDE.md",
        "to": "AGENTS.md",
        "merge": "composite"
      },
      {
        "from": ".claude/rules/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": ".claude/commands/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".claude/agents/**/*.md",
        "to": "agents/**/*.md",
        "map": [
          // Remove the name field added during export
          { "$unset": "name" },
          
          // Reverse model transformation
          {
            "$pipeline": {
              "field": "model",
              "operations": [
                // Step 1: Convert version hyphens back to dots
                // claude-sonnet-4-20250514 → claude-sonnet-4.20250514
                { "$replace": { "pattern": "(-[0-9]+)-([0-9]+)", "with": "$1.$2", "flags": "g" } },
                
                // Step 2: Add anthropic/ prefix ONLY if:
                //   - It starts with "claude-" (Claude model without prefix)
                //   - NOT if it's "default"
                //   - NOT if it already has "anthropic/"
                { "$replace": { "pattern": "^(claude-.+)$", "with": "anthropic/$1" } }
              ]
            }
          },
          
          // Reverse tools transformation: "bash, read" → { bash: true, read: true }
          {
            "$pipeline": {
              "field": "tools",
              "operations": [
                { "$reduce": { "type": "split", "separator": ", " } },
                { "$arrayToObject": { "value": true } }
              ]
            }
          }
        ]
      },
      {
        "from": ".claude/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": ".mcp.json",
        "to": "mcp.jsonc"
      }
    ]
  },

  "codex": {
    "name": "Codex CLI",
    "rootDir": ".codex",
    "rootFile": "AGENTS.md",
    "aliases": ["codexcli"],
    "export": [
      {
        "from": "commands/**/*.md",
        "to": ".codex/prompts/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".codex/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".codex/config.toml",
        "map": [
          // 1. Rename root key
          { "$rename": { "mcpServers": "mcp_servers" } },

          // 2. Extract bearer token from Authorization header
          {
            "$pipeline": {
              "field": "mcp_servers.*.headers.Authorization",
              "operations": [
                { "$extract": {
                    "pattern": "^Bearer \\$\\{env:([A-Z_][A-Z0-9_]*)\\}$",
                    "group": 1,
                    "default": "$SELF"
                }}
              ]
            }
          },
          { "$rename": { "mcp_servers.*.headers.Authorization": "mcp_servers.*.bearer_token_env_var" } },

          // 3. Partition headers into env and static
          {
            "$pipeline": {
              "field": "mcp_servers.*.headers",
              "operations": [
                { "$partition": {
                    "by": "value",
                    "patterns": {
                      "env_http_headers": "^\\$\\{env:.*\\}$",
                      "http_headers": ".*"
                    }
                }}
              ]
            }
          },

          // 4. Extract env var names from env_http_headers
          {
            "$pipeline": {
              "field": "mcp_servers.*.headers.env_http_headers",
              "operations": [
                { "$mapValues": {
                    "operations": [
                      { "$extract": {
                          "pattern": "^\\$\\{env:([A-Z_][A-Z0-9_]*)\\}$",
                          "group": 1
                      }}
                    ]
                }}
              ]
            }
          },

          // 5. Flatten to server level
          { "$rename": { "mcp_servers.*.headers.http_headers": "mcp_servers.*.http_headers" } },
          { "$rename": { "mcp_servers.*.headers.env_http_headers": "mcp_servers.*.env_http_headers" } },
          { "$unset": "mcp_servers.*.headers" },

          // 6. Rename timeout
          { "$rename": { "mcp_servers.*.timeout": "mcp_servers.*.startup_timeout_sec" } },

          // Post-process: Convert to TOML
          { "$pipe": ["json-to-toml"] }
        ],
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".codex/prompts/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".codex/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": ".codex/config.toml",
        "to": "mcp.jsonc",
        "map": [
          // Pre-process: Parse TOML
          { "$pipe": ["toml-to-json"] },

          // 1. Wrap env vars
          {
            "$pipeline": {
              "field": "mcp_servers.*.env_http_headers",
              "operations": [
                { "$mapValues": {
                    "operations": [
                      { "$replace": { "pattern": "^(.+)$", "with": "${env:$1}" } }
                    ]
                }}
              ]
            }
          },

          // 2. Merge headers
          {
            "$pipeline": {
              "field": "mcp_servers.*",
              "operations": [
                { "$mergeFields": {
                    "from": ["http_headers", "env_http_headers"],
                    "to": "headers"
                }}
              ]
            }
          },

          // 3. Reconstruct Authorization header
          {
            "$pipeline": {
              "field": "mcp_servers.*.bearer_token_env_var",
              "operations": [
                { "$replace": { "pattern": "^(.+)$", "with": "Bearer ${env:$1}" } }
              ]
            }
          },
          { "$rename": { "mcp_servers.*.bearer_token_env_var": "mcp_servers.*.headers.Authorization" } },

          // 4. Rename timeout
          { "$rename": { "mcp_servers.*.startup_timeout_sec": "mcp_servers.*.timeout" } },

          // 5. Rename top-level key
          { "$rename": { "mcp_servers": "mcpServers" } }
        ]
      }
    ]
  },

  "cursor": {
    "name": "Cursor",
    "rootDir": ".cursor",
    "rootFile": "AGENTS.md",
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".cursor/rules/**/*.mdc"
      },
      {
        "from": "commands/**/*.md",
        "to": ".cursor/commands/**/*.md"
      },
      {
        "from": "agents/**/*.md",
        "to": ".cursor/agents/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".cursor/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".cursor/mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": [".cursor/rules/**/*.mdc", ".cursor/rules/**/*.md"],
        "to": "rules/**/*.md"
      },
      {
        "from": ".cursor/commands/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".cursor/agents/**/*.md",
        "to": "agents/**/*.md"
      },
      {
        "from": ".cursor/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".cursor/mcp.json", ".cursor/mcp.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "factory": {
    "name": "Factory AI",
    "rootDir": ".factory",
    "rootFile": "AGENTS.md",
    "export": [
      {
        "from": "commands/**/*.md",
        "to": ".factory/commands/**/*.md"
      },
      {
        "from": "agents/**/*.md",
        "to": ".factory/droids/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".factory/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".factory/settings/mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".factory/commands/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".factory/droids/**/*.md",
        "to": "agents/**/*.md"
      },
      {
        "from": ".factory/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".factory/settings/mcp.json", ".factory/settings/mcp.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "kilo": {
    "name": "Kilo Code",
    "rootDir": ".kilocode",
    "rootFile": "AGENTS.md",
    "aliases": ["kilocode"],
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".kilocode/rules/**/*.md"
      },
      {
        "from": "commands/**/*.md",
        "to": ".kilocode/workflows/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".kilocode/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".kilocode/mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".kilocode/rules/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": ".kilocode/workflows/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".kilocode/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".kilocode/mcp.json", ".kilocode/mcp.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "kiro": {
    "name": "Kiro",
    "rootDir": ".kiro",
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".kiro/steering/**/*.md"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".kiro/settings/mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".kiro/steering/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": [".kiro/settings/mcp.json", ".kiro/settings/mcp.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "opencode": {
    "name": "OpenCode",
    "rootDir": ".opencode",
    "rootFile": "AGENTS.md",
    "export": [
      {
        "from": "commands/**/*.md",
        "to": ".opencode/command/**/*.md"
      },
      {
        "from": "agents/**/*.md",
        "to": ".opencode/agent/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".opencode/skill/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".opencode/opencode.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".opencode/command/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".opencode/agent/**/*.md",
        "to": "agents/**/*.md"
      },
      {
        "from": ".opencode/skill/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".opencode/opencode.json", ".opencode/opencode.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "pimono": {
    "name": "Pi-Mono",
    "rootDir": ".pi",
    "rootFile": "AGENTS.md",
    "aliases": ["pi-mono", "pi"],
    "description": "Pi-Mono AI coding assistant framework",
    "export": [
      {
        "from": "commands/**/*.md",
        "to": ".pi/agent/prompts/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".pi/agent/skills/**/*"
      }
    ],
    "import": [
      {
        "from": ".pi/agent/prompts/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".pi/agent/skills/**/*",
        "to": "skills/**/*"
      }
    ]
  },

  "qwen": {
    "name": "Qwen Code",
    "rootDir": ".qwen",
    "rootFile": "QWEN.md",
    "aliases": ["qwencode"],
    "export": [
      {
        "from": "AGENTS.md",
        "to": "QWEN.md",
        "merge": "composite"
      },
      {
        "from": "agents/**/*.md",
        "to": ".qwen/agents/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".qwen/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".qwen/settings.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": "QWEN.md",
        "to": "AGENTS.md",
        "merge": "composite"
      },
      {
        "from": ".qwen/agents/**/*.md",
        "to": "agents/**/*.md"
      },
      {
        "from": ".qwen/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".qwen/settings.json", ".qwen/settings.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "roo": {
    "name": "Roo Code",
    "rootDir": ".roo",
    "rootFile": "AGENTS.md",
    "export": [
      {
        "from": "commands/**/*.md",
        "to": ".roo/commands/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".roo/skills/**/*"
      },
      {
        "from": ["mcp.jsonc", "mcp.json"],
        "to": ".roo/mcp.json",
        "merge": "deep"
      }
    ],
    "import": [
      {
        "from": ".roo/commands/**/*.md",
        "to": "commands/**/*.md"
      },
      {
        "from": ".roo/skills/**/*",
        "to": "skills/**/*"
      },
      {
        "from": [".roo/mcp.json", ".roo/mcp.jsonc"],
        "to": "mcp.jsonc"
      }
    ]
  },

  "warp": {
    "name": "Warp",
    "rootDir": ".warp",
    "rootFile": "WARP.md",
    "export": [
      {
        "from": "AGENTS.md",
        "to": "WARP.md",
        "merge": "composite"
      }
    ],
    "import": [
      {
        "from": "WARP.md",
        "to": "AGENTS.md",
        "merge": "composite"
      }
    ]
  },

  "windsurf": {
    "name": "Windsurf",
    "rootDir": ".windsurf",
    "export": [
      {
        "from": "rules/**/*.md",
        "to": ".windsurf/rules/**/*.md"
      },
      {
        "from": "skills/**/*",
        "to": ".windsurf/skills/**/*"
      }
    ],
    "import": [
      {
        "from": ".windsurf/rules/**/*.md",
        "to": "rules/**/*.md"
      },
      {
        "from": ".windsurf/skills/**/*",
        "to": "skills/**/*"
      }
    ]
  }
}
